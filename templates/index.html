<!DOCTYPE html>
<html lang="vi">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
Â  <title>Dá»¯ liá»‡u Cháº¥m cÃ´ng & Nghá»‰ phÃ©p</title>
Â  <style>
Â  Â  :root {
Â  Â  Â  --bg: #f4f6f9;
Â  Â  Â  --card: #fff;
Â  Â  Â  --primary: #007bff;
Â  Â  Â  --success: #28a745;
Â  Â  Â  --danger: #dc3545;
Â  Â  Â  --muted: #6c757d;
Â  Â  Â  --shadow: 0 3px 12px rgba(0,0,0,0.08);
Â  Â  }
Â  Â  body { font-family: "Segoe UI", Arial, sans-serif; background: var(--bg); margin: 0; padding: 20px; }
Â  Â  h1 { text-align: center; color: var(--primary); }
Â  Â  .controls { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; align-items: center; }
Â  Â  button {
Â  Â  Â  background: var(--primary);
Â  Â  Â  color: white; border: none;
Â  Â  Â  padding: 6px 12px; border-radius: 6px;
Â  Â  Â  cursor: pointer; font-size: 14px;
Â  Â  Â  transition: 0.2s;
Â  Â  }
Â  Â  button:hover { opacity: 0.9; }
Â  Â  button.active { background: var(--success); }
Â  Â  select, input[type=text], input[type=email], input[type=password], input[type=date] {
Â  Â  Â  padding: 6px 8px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px;
Â  Â  }
Â  Â  table { width: 100%; border-collapse: collapse; background: white; box-shadow: var(--shadow); }
Â  Â  th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
Â  Â  th { background: var(--primary); color: white; cursor: pointer; user-select: none; }
Â  Â  th.asc::after { content: " â†‘"; font-size: 12px; }
Â  Â  th.desc::after { content: " â†“"; font-size: 12px; }
Â  Â  tr:nth-child(even) { background: #f8f9fa; }
Â  Â  .pagination { text-align: center; margin-top: 15px; }
Â  Â  .pagination button {
Â  Â  Â  background: white; border: 1px solid #ccc; color: var(--primary);
Â  Â  Â  margin: 2px; border-radius: 4px; padding: 5px 10px;
Â  Â  }
Â  Â  .pagination button.active { background: var(--primary); color: white; }
Â  Â  img.checkin-photo { height: 60px; width: auto; border-radius: 6px; object-fit: cover; }
Â  Â  .login-box { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
Â  Â  .msg { margin: 10px 0; padding: 8px 10px; border-radius: 6px; }
Â  Â  .msg.error { background: #ffe6e6; color: var(--danger); }
Â  Â  .msg.success { background: #e8fbe8; color: var(--success); }
Â  Â  a.map-link { color: var(--primary); text-decoration: none; font-weight: 500; }
Â  Â  a.map-link:hover { text-decoration: underline; }
Â  Â  /* áº¨n cÃ¡c pháº§n sau Ä‘Äƒng nháº­p ban Ä‘áº§u */
Â  Â  #greeting, #dataTabs, #filters, #dateFilter, #searchFilter, #tableContainer, #pagination { display: none; }
Â  Â  #greeting { text-align: center; margin: 10px 0; font-size: 18px; color: var(--primary); font-weight: bold; }
Â  Â  #dataTabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; }
Â  Â  #dataTabs button { padding: 8px 16px; font-size: 15px; min-width: 120px; }
Â  Â  #leaveSection { display: none; }
Â  Â  #leaveTableContainer table th:first-child { min-width: 100px; }
Â  Â Â 
Â  Â  /* Style má»›i cho Export Dropdown */
Â  Â  .export-group { display: flex; gap: 5px; align-items: center; }
Â  </style>
</head>
<body>
Â  <h1>ğŸ“Dá»¯ liá»‡u Cháº¥m cÃ´ng & Nghá»‰ phÃ©p</h1>
Â  <div class="controls login-box">
Â  Â  <input type="email" id="loginEmail" placeholder="Nháº­p email admin..." />
Â  Â  <input type="password" id="loginPass" placeholder="Máº­t kháº©u..." />
Â  Â  <button id="loginBtn">ÄÄƒng nháº­p</button>
Â  Â  <button id="logoutBtn" style="display:none;background:var(--danger);">ÄÄƒng xuáº¥t</button>
Â  Â  <a href="/forgot-password" style="color:var(--muted);font-size:13px;text-decoration:none;">Reset máº­t kháº©u</a>
Â  </div>
Â  <div id="messageArea"></div>
Â  <div id="greeting"></div>
Â  <div id="dataTabs">
Â  Â  <button id="tabAttendance" class="active" onclick="switchTab('attendance')">Äiá»ƒm danh</button>
Â  Â  <button id="tabLeave" onclick="switchTab('leave')">Nghá»‰ phÃ©p</button>
Â  </div>
Â Â 
Â  <div id="filters" class="controls">
Â  Â  <label><b>Bá»™ lá»c:</b></label>
Â  Â  <button onclick="applyFilter('hÃ´m nay')" id="btn-homnay">HÃ´m nay</button>
Â  Â  <button onclick="applyFilter('tuáº§n')" id="btn-tuan">Tuáº§n</button>
Â  Â  <button onclick="applyFilter('thÃ¡ng')" id="btn-thang">ThÃ¡ng</button>
Â  Â  <button onclick="applyFilter('nÄƒm')" id="btn-nam">NÄƒm</button>
Â  Â  <button onclick="applyFilter('táº¥t cáº£')" id="btn-tatca">Táº¥t cáº£</button>
Â  </div>
Â Â 
Â  <div id="dateFilter" class="controls">
Â  Â  <label><b>Tá»« ngÃ y:</b></label><input type="date" id="startDate" />
Â  Â  <label><b>Äáº¿n ngÃ y:</b></label><input type="date" id="endDate" />
Â  Â  <button onclick="applyDateRange()">Ãp dá»¥ng</button>
Â  </div>
Â Â 
Â  <div id="searchFilter" class="controls">
Â  Â  <input type="text" id="searchBox" placeholder="Nháº­p tÃªn hoáº·c mÃ£ nhÃ¢n viÃªn..." />
Â  Â  <select id="rowsPerPage" onchange="updateRowsPerPage()">
Â  Â  Â  <option value="5">5 dÃ²ng</option>
Â  Â  Â  <option value="10" selected>10 dÃ²ng</option>
Â  Â  Â  <option value="20">20 dÃ²ng</option>
Â  Â  Â  <option value="25">25 dÃ²ng</option>
Â  Â  </select>
Â  Â  <button onclick="applySearch()">TÃ¬m kiáº¿m</button>
Â  Â Â 
Â  Â  <div class="export-group" id="exportGroupAttendance">
Â  Â  Â  Â  <select id="exportOptionsAttendance" style="border: 1px solid var(--primary);">
Â  Â  Â  Â  Â  Â  <option value="">-- Chá»n loáº¡i file --</option>
Â  Â  Â  Â  Â  Â  <option value="attendance">Äiá»ƒm Danh Theo Filter Hiá»‡n Táº¡i</option>
Â  Â  Â  Â  Â  Â  <option value="leave">Nghá»‰ PhÃ©p Theo Filter Hiá»‡n Táº¡i</option>
Â  Â  Â  Â  Â  Â  <option value="combined">ToÃ n Bá»™ (Cáº£ hai) Theo Filter Hiá»‡n Táº¡i</option>
Â  Â  Â  Â  </select>
Â  Â  Â  Â  <button onclick="handleExportClick()">ğŸ“¤ Xuáº¥t Dá»¯ Liá»‡u</button>Â 
Â  Â  </div>
Â  Â  <button onclick="refreshData()">ğŸ”„ LÃ m má»›i</button>
Â  Â  <button onclick="resetFilter()">â†» Reset</button>
Â  </div>
Â Â 
Â  <div id="tableContainer" class="table-container">
Â  Â  <table id="dataTable">
Â  Â  Â  <thead>
Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  <th onclick="sortTable('EmployeeId')">MÃ£ NV</th>
Â  Â  Â  Â  Â  <th onclick="sortTable('EmployeeName')">TÃªn nhÃ¢n viÃªn</th>
Â  Â  Â  Â  Â  <th onclick="sortTable('CheckinDate')">NgÃ y</th>
Â  Â  Â  Â  Â  <th onclick="sortTable('CheckinTime')">Giá» Check-in</th>
Â  Â  Â  Â  Â  <th onclick="sortTable('ProjectId')">MÃ£ dá»± Ã¡n</th>
Â  Â  Â  Â  Â  <th onclick="sortTable('Tasks')">CÃ´ng viá»‡c</th>
Â  Â  Â  Â  Â  <th onclick="sortTable('OtherNote')">CÃ´ng viá»‡c khÃ¡c</th>
Â  Â  Â  Â  Â  <th>áº¢nh</th>
Â  Â  Â  Â  Â  <th>Äá»‹a chá»‰</th>
Â  Â  Â  Â  Â  <th>Vá»‹ trÃ­</th>
Â  Â  Â  Â  Â  <th onclick="sortTable('Status')">Tráº¡ng thÃ¡i</th>
Â  Â  Â  Â  </tr>
Â  Â  Â  </thead>
Â  Â  Â  <tbody id="dataBody"></tbody>
Â  Â  </table>
Â  </div>
Â  <div id="pagination" class="pagination"></div>
Â Â 
Â  <div id="leaveSection">
Â  Â  <div class="controls">
Â  Â  Â  <label><b>Bá»™ lá»c:</b></label>
Â  Â  Â  <button onclick="applyLeaveFilter('hÃ´m nay')" id="leave-btn-homnay">HÃ´m nay</button>
Â  Â  Â  <button onclick="applyLeaveFilter('tuáº§n')" id="leave-btn-tuan">Tuáº§n</button>
Â  Â  Â  <button onclick="applyLeaveFilter('thÃ¡ng')" id="leave-btn-thang">ThÃ¡ng</button>
Â  Â  Â  <button onclick="applyLeaveFilter('nÄƒm')" id="leave-btn-nam">NÄƒm</button>
Â  Â  Â  <button onclick="applyLeaveFilter('táº¥t cáº£')" id="leave-btn-tatca">Táº¥t cáº£</button>
Â  Â  </div>
Â  Â  <div class="controls">
Â  Â  Â  <label><b>Tá»« ngÃ y:</b></label><input type="date" id="leaveStartDate" />
Â  Â  Â  <label><b>Äáº¿n ngÃ y:</b></label><input type="date" id="leaveEndDate" />
Â  Â  Â  <button onclick="applyLeaveDateRange()">Ãp dá»¥ng</button>
Â  Â  </div>
Â  Â  <div class="controls">
Â  Â  Â  <input type="text" id="leaveSearchBox" placeholder="Nháº­p tÃªn hoáº·c mÃ£ nhÃ¢n viÃªn..." />
Â  Â  Â  <select id="leaveRowsPerPage" onchange="updateLeaveRowsPerPage()">
Â  Â  Â  Â  <option value="5">5 dÃ²ng</option>
Â  Â  Â  Â  <option value="10" selected>10 dÃ²ng</option>
Â  Â  Â  Â  <option value="20">20 dÃ²ng</option>
Â  Â  Â  Â  <option value="25">25 dÃ²ng</option>
Â  Â  Â  </select>
Â  Â  Â  <button onclick="applyLeaveSearch()">TÃ¬m kiáº¿m</button>
Â  Â  Â  <div class="export-group" id="exportGroupLeave">
Â  Â  Â  Â  <select id="exportOptionsLeave" style="border: 1px solid var(--primary);">
Â  Â  Â  Â  Â  Â  <option value="">-- Chá»n loáº¡i file --</option>
Â  Â  Â  Â  Â  Â  <option value="attendance">Äiá»ƒm Danh Theo Filter Hiá»‡n Táº¡i</option>
Â  Â  Â  Â  Â  Â  <option value="leave">Nghá»‰ PhÃ©p Theo Filter Hiá»‡n Táº¡i</option>
Â  Â  Â  Â  Â  Â  <option value="combined">ToÃ n Bá»™ (Cáº£ hai) Theo Filter Hiá»‡n Táº¡i</option>
Â  Â  Â  Â  </select>
Â  Â  Â  Â  <button onclick="handleExportClick()">ğŸ“¤ Xuáº¥t Dá»¯ Liá»‡u</button>Â 
Â  Â  Â  </div>
Â  Â  Â  <button onclick="refreshLeaveData()">ğŸ”„ LÃ m má»›i</button>
Â  Â  Â  <button onclick="resetLeaveFilter()">â†» Reset</button>
Â  Â  </div>
Â  Â  <div id="leaveTableContainer" class="table-container">
Â  Â  Â  <table id="leaveTable">
Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  <th onclick="sortLeaveTable('EmployeeId')">MÃ£ NV</th>
Â  Â  Â  Â  Â  Â  <th onclick="sortLeaveTable('EmployeeName')">TÃªn nhÃ¢n viÃªn</th>
Â  Â  Â  Â  Â  Â  <th onclick="sortLeaveTable('CheckinDate')">NgÃ y nghá»‰</th>
Â  Â  Â  Â  Â  Â  <th onclick="sortLeaveTable('CheckinTime')">NgÃ y táº¡o Ä‘Æ¡n</th>
Â  Â  Â  Â  Â  Â  <th onclick="sortLeaveTable('Tasks')">Ghi chÃº</th>
Â  Â  Â  Â  Â  Â  <th onclick="sortLeaveTable('Status')">Tráº¡ng thÃ¡i</th>
Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  </thead>
Â  Â  Â  Â  <tbody id="leaveDataBody"></tbody>
Â  Â  Â  </table>
Â  Â  </div>
Â  Â  <div id="leavePagination" class="pagination"></div>
Â  </div>
Â Â 
Â  <script>
Â  Â  let currentTab = "attendance";
Â  Â  let currentFilter = "hÃ´m nay";
Â  Â  let currentSearch = "";
Â  Â  let currentSort = { column: null, order: null };
Â  Â  let startDate = "", endDate = "";
Â  Â  let rawData = [];
Â  Â  let currentPage = 1;
Â  Â  let rowsPerPage = 10;
Â  Â  // Biáº¿n cho pháº§n nghá»‰ phÃ©p
Â  Â  let currentLeaveFilter = "hÃ´m nay";
Â  Â  let currentLeaveSearch = "";
Â  Â  let currentLeaveSort = { column: null, order: null };
Â  Â  let leaveStartDate = "", leaveEndDate = "";
Â  Â  let rawLeaveData = [];
Â  Â  let currentLeavePage = 1;
Â  Â  let leaveRowsPerPage = 10;
Â  Â Â 
Â  Â  function showMessage(msg, type="success") {
Â  Â  Â  const el = document.getElementById("messageArea");
Â  Â  Â  el.innerHTML = `<div class="msg ${type}">${msg}</div>`;
Â  Â  Â  setTimeout(()=>el.innerHTML="", 4000);
Â  Â  }
Â  Â Â 
Â  Â  function showDashboard() {
Â  Â  Â  document.getElementById("greeting").style.display = "block";
Â  Â  Â  document.getElementById("dataTabs").style.display = "flex";
Â  Â  Â  switchTab(currentTab); // Hiá»ƒn thá»‹ tab hiá»‡n táº¡i
Â  Â  }
Â  Â Â 
Â  Â  function hideDashboard() {
Â  Â  Â  document.getElementById("greeting").style.display = "none";
Â  Â  Â  document.getElementById("dataTabs").style.display = "none";
Â  Â  Â  document.getElementById("leaveSection").style.display = "none";
Â  Â  Â  document.getElementById("filters").style.display = "none";
Â  Â  Â  document.getElementById("dateFilter").style.display = "none";
Â  Â  Â  document.getElementById("searchFilter").style.display = "none";
Â  Â  Â  document.getElementById("tableContainer").style.display = "none";
Â  Â  Â  document.getElementById("pagination").style.display = "none";
Â  Â  Â  document.getElementById("dataBody").innerHTML = "";
Â  Â  Â  document.getElementById("leaveDataBody").innerHTML = "";
Â  Â  }
Â  Â Â 
Â  Â  function resetExportOptions() {
Â  Â  Â  document.getElementById('exportOptionsAttendance').value = "";
Â  Â  Â  document.getElementById('exportOptionsLeave').value = "";
Â  Â  }

Â  Â  function switchTab(tab) {
Â  Â  Â  currentTab = tab;
Â  Â  Â  document.getElementById("tabAttendance").classList.toggle("active", tab === "attendance");
Â  Â  Â  document.getElementById("tabLeave").classList.toggle("active", tab === "leave");
Â  Â  Â  resetExportOptions(); // Reset combobox khi chuyá»ƒn tab

Â  Â  Â  if (tab === "attendance") {
Â  Â  Â  Â  document.getElementById("leaveSection").style.display = "none";
Â  Â  Â  Â  // Hiá»ƒn thá»‹ cÃ¡c controls chung cho tab Äiá»ƒm danh
Â  Â  Â  Â  document.getElementById("filters").style.display = "flex";
Â  Â  Â  Â  document.getElementById("dateFilter").style.display = "flex";
Â  Â  Â  Â  document.getElementById("searchFilter").style.display = "flex";
Â  Â  Â  Â  document.getElementById("tableContainer").style.display = "block";
Â  Â  Â  Â  document.getElementById("pagination").style.display = "block";
Â  Â  Â  Â  
Â  Â  Â  Â  // áº¨n/hiá»‡n export group
Â  Â  Â  Â  document.getElementById("exportGroupAttendance").style.display = "flex";
Â  Â  Â  Â  
Â  Â  Â  Â  loadData(); // Táº£i láº¡i dá»¯ liá»‡u Ä‘iá»ƒm danh
Â  Â  Â  } else {
Â  Â  Â  Â  // áº¨n cÃ¡c controls chung
Â  Â  Â  Â  document.getElementById("filters").style.display = "none";
Â  Â  Â  Â  document.getElementById("dateFilter").style.display = "none";
Â  Â  Â  Â  document.getElementById("searchFilter").style.display = "none";
Â  Â  Â  Â  document.getElementById("tableContainer").style.display = "none";
Â  Â  Â  Â  document.getElementById("pagination").style.display = "none";
Â  Â  Â  Â  
Â  Â  Â  Â  // Hiá»ƒn thá»‹ section Nghá»‰ phÃ©p
Â  Â  Â  Â  document.getElementById("leaveSection").style.display = "block";
Â  Â  Â  Â  
Â  Â  Â  Â  // Export group cá»§a Attendance pháº£i Ä‘Æ°á»£c áº©n khi á»Ÿ tab Leave
Â  Â  Â  Â  document.getElementById("exportGroupAttendance").style.display = "none";
Â  Â  Â  Â  
Â  Â  Â  Â  loadLeaveData(); // Táº£i dá»¯ liá»‡u nghá»‰ phÃ©p
Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  // --- LOGIN LOGIC ---
Â  Â  async function login() {
Â  Â  Â  const email = document.getElementById("loginEmail").value.trim();
Â  Â  Â  const pass = document.getElementById("loginPass").value;
Â  Â  Â  if (!email || !pass) return showMessage("âš ï¸ Nháº­p email vÃ  máº­t kháº©u", "error");
Â  Â  Â  const formData = new FormData();
Â  Â  Â  formData.append("email", email);
Â  Â  Â  formData.append("password", pass);
Â  Â  Â  const res = await fetch("/login", { method: "POST", body: formData });
Â  Â  Â  const data = await res.json();
Â  Â  Â  if (res.ok && data.success) {
Â  Â  Â  Â  localStorage.setItem("adminEmail", email);
Â  Â  Â  Â  localStorage.setItem("adminUser", data.username || data.email);
Â  Â  Â  Â  document.getElementById("loginEmail").style.display = "none";
Â  Â  Â  Â  document.getElementById("loginPass").style.display = "none";
Â  Â  Â  Â  document.getElementById("loginBtn").style.display = "none";
Â  Â  Â  Â  document.getElementById("logoutBtn").style.display = "inline-block";
Â  Â  Â  Â  document.getElementById("greeting").innerHTML = `Xin chÃ o, ${data.username || email}!`;
Â  Â  Â  Â  showDashboard();
Â  Â  Â  Â  showMessage("âœ… ÄÄƒng nháº­p thÃ nh cÃ´ng", "success");
Â  Â  Â  Â  applyFilter("hÃ´m nay");
Â  Â  Â  } else showMessage(data.message || "ğŸš« Sai thÃ´ng tin", "error");
Â  Â  }
Â  Â Â 
Â  Â  function logout() {
Â  Â  Â  localStorage.clear();
Â  Â  Â  document.getElementById("loginEmail").style.display = "";
Â  Â  Â  document.getElementById("loginPass").style.display = "";
Â  Â  Â  document.getElementById("loginBtn").style.display = "";
Â  Â  Â  document.getElementById("logoutBtn").style.display = "none";
Â  Â  Â  hideDashboard();
Â  Â  Â  showMessage("ğŸ‘‹ ÄÃ£ Ä‘Äƒng xuáº¥t", "success");
Â  Â  }
Â  Â Â 
Â  Â  document.getElementById("loginBtn").onclick = login;
Â  Â  document.getElementById("logoutBtn").onclick = logout;
Â  Â Â 
Â  Â  // --- FETCH DATA FOR ATTENDANCE ---
Â  Â  async function loadData() {
Â  Â  Â  const email = localStorage.getItem("adminEmail");
Â  Â  Â  if (!email) return showMessage("ğŸš« ChÆ°a Ä‘Äƒng nháº­p!", "error");
Â  Â  Â  let url = `/api/attendances?email=${encodeURIComponent(email)}&filter=${encodeURIComponent(currentFilter)}`;
Â  Â  Â  if (startDate && endDate) url += `&startDate=${startDate}&endDate=${endDate}`;
Â  Â  Â  if (currentSearch) url += `&search=${encodeURIComponent(currentSearch)}`;
Â  Â  Â  const res = await fetch(url);
Â  Â  Â  const data = await res.json();
Â  Â  Â  if (!res.ok) return showMessage(data.error || "âŒ Lá»—i táº£i dá»¯ liá»‡u", "error");
Â  Â  Â  rawData = data;
Â  Â  Â  currentPage = 1;
Â  Â  Â  renderTable();
Â  Â  }
Â  Â Â 
Â  Â  // --- TABLE RENDER FOR ATTENDANCE ---
Â  Â  function renderTable() {
Â  Â  Â  const tbody = document.getElementById("dataBody");
Â  Â  Â  tbody.innerHTML = "";
Â  Â  Â  let data = [...rawData];
Â  Â  Â  if (currentSort.column && currentSort.order) {
Â  Â  Â  Â  data.sort((a,b)=>{
Â  Â  Â  Â  Â  let A = a[currentSort.column]||"", B = b[currentSort.column]||"";
Â  Â  Â  Â  Â  if (A<B) return currentSort.order==="asc" ? -1 : 1;
Â  Â  Â  Â  Â  if (A>B) return currentSort.order==="asc" ? 1 : -1;
Â  Â  Â  Â  Â  return 0;
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  Â  const startIdx = (currentPage-1)*rowsPerPage;
Â  Â  Â  const pageData = data.slice(startIdx, startIdx+rowsPerPage);
Â  Â  Â  pageData.forEach(r=>{
Â  Â  Â  Â  const img = r.FaceImage || r.PhotoURL ? `<img src="${r.FaceImage || r.PhotoURL}" class="checkin-photo">` : "";
Â  Â  Â  Â  // Sá»­a lá»—i cÃº phÃ¡p URL trong template literal (Ä‘Ã£ sá»­a lá»—i cÃº phÃ¡p Google Maps)
Â  Â  Â  Â  const mapLink = (r.Latitude && r.Longitude)
Â  Â  Â  Â  Â  ? `<a href="https://maps.google.com/?q=${r.Latitude},${r.Longitude}" target="_blank" class="map-link">Xem</a>`
Â  Â  Â  Â  Â  : "";
Â  Â  Â  Â  tbody.innerHTML += `
Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  <td>${r.EmployeeId||""}</td>
Â  Â  Â  Â  Â  Â  <td>${r.EmployeeName||""}</td>
Â  Â  Â  Â  Â  Â  <td>${r.CheckinDate||""}</td>
Â  Â  Â  Â  Â  Â  <td>${r.CheckinTime||""}</td>
Â  Â  Â  Â  Â  Â  <td>${r.ProjectId||""}</td>
Â  Â  Â  Â  Â  Â  <td>${Array.isArray(r.Tasks) ? r.Tasks.join(', ') : (r.Tasks || "")}</td>
Â  Â  Â  Â  Â  Â  <td>${r.OtherNote||""}</td>
Â  Â  Â  Â  Â  Â  <td>${img}</td>
Â  Â  Â  Â  Â  Â  <td>${r.Address||""}</td>
Â  Â  Â  Â  Â  Â  <td>${mapLink}</td>
Â  Â  Â  Â  Â  Â  <td>${r.Status||""}</td>
Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  `;
Â  Â  Â  });
Â  Â  Â  renderPagination(data.length);
Â  Â  Â  highlightFilterButton();
Â  Â  }
Â  Â Â 
Â  Â  // --- LEAVE DATA FUNCTIONS ---
Â  Â  async function loadLeaveData() {
Â  Â  Â  const email = localStorage.getItem("adminEmail");
Â  Â  Â  if (!email) return showMessage("ğŸš« ChÆ°a Ä‘Äƒng nháº­p!", "error");
Â  Â  Â  let url = `/api/leaves?email=${encodeURIComponent(email)}&filter=${encodeURIComponent(currentLeaveFilter)}`;
Â  Â  Â  if (leaveStartDate && leaveEndDate) url += `&startDate=${leaveStartDate}&endDate=${leaveEndDate}`;
Â  Â  Â  if (currentLeaveSearch) url += `&search=${encodeURIComponent(currentLeaveSearch)}`;
Â  Â  Â  const res = await fetch(url);
Â  Â  Â  const data = await res.json();
Â  Â  Â  if (!res.ok) return showMessage(data.error || "âŒ Lá»—i táº£i dá»¯ liá»‡u nghá»‰ phÃ©p", "error");
Â  Â  Â  rawLeaveData = data;
Â  Â  Â  currentLeavePage = 1;
Â  Â  Â  renderLeaveTable();
Â  Â  }
Â  Â Â 
Â  Â  function renderLeaveTable() {
Â  Â  Â  const tbody = document.getElementById("leaveDataBody");
Â  Â  Â  tbody.innerHTML = "";
Â  Â  Â  let data = [...rawLeaveData];
Â  Â  Â  if (currentLeaveSort.column && currentLeaveSort.order) {
Â  Â  Â  Â  data.sort((a,b)=>{
Â  Â  Â  Â  Â  let A = a[currentLeaveSort.column]||"", B = b[currentLeaveSort.column]||"";
Â  Â  Â  Â  Â  if (A<B) return currentLeaveSort.order==="asc" ? -1 : 1;
Â  Â  Â  Â  Â  if (A>B) return currentLeaveSort.order==="asc" ? 1 : -1;
Â  Â  Â  Â  Â  return 0;
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  Â  const startIdx = (currentLeavePage-1)*leaveRowsPerPage;
Â  Â  Â  const pageData = data.slice(startIdx, startIdx+leaveRowsPerPage);
Â  Â  Â  pageData.forEach(r=>{
Â  Â  Â  Â  tbody.innerHTML += `
Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  <td>${r.EmployeeId||""}</td>
Â  Â  Â  Â  Â  Â  <td>${r.EmployeeName||""}</td>
Â  Â  Â  Â  Â  Â  <td>${r.CheckinDate||""}</td>
Â  Â  Â  Â  Â  Â  <td>${r.CheckinTime||""}</td>
Â  Â  Â  Â  Â  Â  <td>${Array.isArray(r.Tasks) ? r.Tasks.join(', ') : (r.Tasks || "")}</td>
Â  Â  Â  Â  Â  Â  <td>${r.Status||""}</td>
Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  `;
Â  Â  Â  });
Â  Â  Â  renderLeavePagination(data.length);
Â  Â  Â  highlightLeaveFilterButton();
Â  Â  }
Â  Â Â 
Â  Â  function renderPagination(total) {
Â  Â  Â  const pages = Math.ceil(total / rowsPerPage);
Â  Â  Â  const pagDiv = document.getElementById("pagination");
Â  Â  Â  pagDiv.innerHTML = "";
Â  Â  Â  for (let i=1;i<=pages;i++) {
Â  Â  Â  Â  pagDiv.innerHTML += `<button class="${i===currentPage?'active':''}" onclick="gotoPage(${i})">${i}</button>`;
Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  function renderLeavePagination(total) {
Â  Â  Â  const pages = Math.ceil(total / leaveRowsPerPage);
Â  Â  Â  const pagDiv = document.getElementById("leavePagination");
Â  Â  Â  pagDiv.innerHTML = "";
Â  Â  Â  for (let i=1;i<=pages;i++) {
Â  Â  Â  Â  pagDiv.innerHTML += `<button class="${i===currentLeavePage?'active':''}" onclick="gotoLeavePage(${i})">${i}</button>`;
Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  function gotoPage(page) {
Â  Â  Â  currentPage = page;
Â  Â  Â  renderTable();
Â  Â  }
Â  Â Â 
Â  Â  function gotoLeavePage(page) {
Â  Â  Â  currentLeavePage = page;
Â  Â  Â  renderLeaveTable();
Â  Â  }
Â  Â Â 
Â  Â  function sortTable(col) {
Â  Â  Â  if (currentSort.column===col) {
Â  Â  Â  Â  currentSort.order = currentSort.order==="asc" ? "desc" : (currentSort.order==="desc"?null:"asc");
Â  Â  Â  } else {
Â  Â  Â  Â  currentSort.column = col;
Â  Â  Â  Â  currentSort.order = "asc";
Â  Â  Â  }
Â  Â  Â  document.querySelectorAll("#dataTable th").forEach(th=>th.classList.remove("asc","desc"));
Â  Â  Â  if (currentSort.order)
Â  Â  Â  Â  document.querySelector(`#dataTable th[onclick="sortTable('${col}')"]`).classList.add(currentSort.order);
Â  Â  Â  renderTable();
Â  Â  }
Â  Â Â 
Â  Â  function sortLeaveTable(col) {
Â  Â  Â  if (currentLeaveSort.column===col) {
Â  Â  Â  Â  currentLeaveSort.order = currentLeaveSort.order==="asc" ? "desc" : (currentLeaveSort.order==="desc"?null:"asc");
Â  Â  Â  } else {
Â  Â  Â  Â  currentLeaveSort.column = col;
Â  Â  Â  Â  currentLeaveSort.order = "asc";
Â  Â  Â  }
Â  Â  Â  document.querySelectorAll("#leaveTable th").forEach(th=>th.classList.remove("asc","desc"));
Â  Â  Â  if (currentLeaveSort.order)
Â  Â  Â  Â  document.querySelector(`#leaveTable th[onclick="sortLeaveTable('${col}')"]`).classList.add(currentLeaveSort.order);
Â  Â  Â  renderLeaveTable();
Â  Â  }
Â  Â Â 
Â  Â  function applyFilter(f) {
Â  Â  Â  currentFilter = f;
Â  Â  Â  startDate = endDate = "";
Â  Â  Â  loadData();
Â  Â  }
Â  Â Â 
Â  Â  function applyLeaveFilter(f) {
Â  Â  Â  currentLeaveFilter = f;
Â  Â  Â  leaveStartDate = leaveEndDate = "";
Â  Â  Â  loadLeaveData();
Â  Â  }
Â  Â Â 
Â  Â  function applyDateRange() {
Â  Â  Â  startDate = document.getElementById("startDate").value;
Â  Â  Â  endDate = document.getElementById("endDate").value;
Â  Â  Â  currentFilter = "custom";
Â  Â  Â  loadData();
Â  Â  }
Â  Â Â 
Â  Â  function applyLeaveDateRange() {
Â  Â  Â  leaveStartDate = document.getElementById("leaveStartDate").value;
Â  Â  Â  leaveEndDate = document.getElementById("leaveEndDate").value;
Â  Â  Â  currentLeaveFilter = "custom";
Â  Â  Â  loadLeaveData();
Â  Â  }
Â  Â Â 
Â  Â  function applySearch() {
Â  Â  Â  currentSearch = document.getElementById("searchBox").value.trim();
Â  Â  Â  loadData();
Â  Â  }
Â  Â Â 
Â  Â  function applyLeaveSearch() {
Â  Â  Â  currentLeaveSearch = document.getElementById("leaveSearchBox").value.trim();
Â  Â  Â  loadLeaveData();
Â  Â  }

Â  Â  // --- HÃ€M Má»šI KHI Báº¤M NÃšT "XUáº¤T Dá»® LIá»†U" ---
Â  Â  function handleExportClick() {
Â  Â  Â  Â  const email = localStorage.getItem("adminEmail");
Â  Â  Â  Â  let exportOptionsEl;
Â  Â  Â  Â  let url = "";

Â  Â  Â  Â  if (!email) {
Â  Â  Â  Â  Â  Â  showMessage("âš ï¸ ChÆ°a Ä‘Äƒng nháº­p", "error");
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  // Láº¥y combobox vÃ  filter tÆ°Æ¡ng á»©ng vá»›i tab hiá»‡n táº¡i
Â  Â  Â  Â  if (currentTab === "attendance") {
Â  Â  Â  Â  Â  Â  exportOptionsEl = document.getElementById('exportOptionsAttendance');
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  } else if (currentTab === "leave") {
Â  Â  Â  Â  Â  Â  exportOptionsEl = document.getElementById('exportOptionsLeave');
Â  Â  Â  Â  }

Â  Â  Â  Â  const exportType = exportOptionsEl ? exportOptionsEl.value : "";
Â  Â  Â  Â  
Â  Â  Â  Â  if (exportType === "") {
Â  Â  Â  Â  Â  Â  showMessage("âš ï¸ Vui lÃ²ng chá»n loáº¡i dá»¯ liá»‡u cáº§n xuáº¥t!", "error");
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  // XÃ¢y dá»±ng URL dá»±a trÃªn exportType
Â  Â  Â  Â  if (exportType === "attendance") {
Â  Â  Â  Â  Â  Â  url = `/api/attendances/export-excel?email=${encodeURIComponent(email)}&filter=${encodeURIComponent(currentFilter)}`;
Â  Â  Â  Â  Â  Â  if (startDate && endDate) url += `&startDate=${startDate}&endDate=${endDate}`;
Â  Â  Â  Â  Â  Â  if (currentSearch) url += `&search=${encodeURIComponent(currentSearch)}`;
Â  Â  Â  Â  } else if (exportType === "leave") {
Â  Â  Â  Â  Â  Â  url = `/api/export-leaves-excel?email=${encodeURIComponent(email)}&filter=${encodeURIComponent(currentLeaveFilter)}`;
Â  Â  Â  Â  Â  Â  if (leaveStartDate && leaveEndDate) url += `&startDate=${leaveStartDate}&endDate=${leaveEndDate}`;
Â  Â  Â  Â  Â  Â  if (currentLeaveSearch) url += `&search=${encodeURIComponent(currentLeaveSearch)}`;
Â  Â  Â  Â  } else if (exportType === "combined") {
Â  Â  Â  Â  Â  Â  // Xuáº¥t ToÃ n Bá»™ (Combined) - Láº¥y bá»™ lá»c cá»§a tab Ä‘ang hiá»ƒn thá»‹
Â  Â  Â  Â  Â  Â  let activeFilter = currentTab === "attendance" ? currentFilter : currentLeaveFilter;
Â  Â  Â  Â  Â  Â  let activeStartDate = currentTab === "attendance" ? startDate : leaveStartDate;
Â  Â  Â  Â  Â  Â  let activeEndDate = currentTab === "attendance" ? endDate : leaveEndDate;
Â  Â  Â  Â  Â  Â  let activeSearch = currentTab === "attendance" ? currentSearch : currentLeaveSearch;

Â  Â  Â  Â  Â  Â  url = `/api/export-combined-excel?email=${encodeURIComponent(email)}`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  url += `&filter=${encodeURIComponent(activeFilter)}`;
Â  Â  Â  Â  Â  Â  if (activeStartDate && activeEndDate) url += `&startDate=${activeStartDate}&endDate=${activeEndDate}`;
Â  Â  Â  Â  Â  Â  if (activeSearch) url += `&search=${encodeURIComponent(activeSearch)}`;
Â  Â  Â  Â  }

Â  Â  Â  Â  if (url) {
Â  Â  Â  Â  Â  Â  window.location.href = url;
Â  Â  Â  Â  Â  Â  // Reset select box sau khi xuáº¥t
Â  Â  Â  Â  Â  Â  exportOptionsEl.value = "";
Â  Â  Â  Â  }
Â  Â  }
Â  Â  // --- Káº¾T THÃšC HÃ€M EXPORT Má»šI ---

Â  Â  function updateRowsPerPage() {
Â  Â  Â  rowsPerPage = parseInt(document.getElementById("rowsPerPage").value);
Â  Â  Â  currentPage = 1;
Â  Â  Â  renderTable();
Â  Â  }
Â  Â Â 
Â  Â  function updateLeaveRowsPerPage() {
Â  Â  Â  leaveRowsPerPage = parseInt(document.getElementById("leaveRowsPerPage").value);
Â  Â  Â  currentLeavePage = 1;
Â  Â  Â  renderLeaveTable();
Â  Â  }
Â  Â Â 
Â  Â  function refreshData() {
Â  Â  Â  loadData();
Â  Â  }
Â  Â Â 
Â  Â  function refreshLeaveData() {
Â  Â  Â  loadLeaveData();
Â  Â  }
Â  Â Â 
Â  Â  function resetFilter() {
Â  Â  Â  currentSearch = "";
Â  Â  Â  startDate = endDate = "";
Â  Â  Â  currentFilter = "hÃ´m nay";
Â  Â  Â  document.getElementById("searchBox").value = "";
Â  Â  Â  document.getElementById("startDate").value = "";
Â  Â  Â  document.getElementById("endDate").value = "";
Â  Â  Â  highlightFilterButton();
Â  Â  Â  loadData();
Â  Â  }
Â  Â Â 
Â  Â  function resetLeaveFilter() {
Â  Â  Â  currentLeaveSearch = "";
Â  Â  Â  leaveStartDate = leaveEndDate = "";
Â  Â  Â  currentLeaveFilter = "hÃ´m nay";
Â  Â  Â  document.getElementById("leaveSearchBox").value = "";
Â  Â  Â  document.getElementById("leaveStartDate").value = "";
Â  Â  Â  document.getElementById("leaveEndDate").value = "";
Â  Â  Â  highlightLeaveFilterButton();
Â  Â  Â  loadLeaveData();
Â  Â  }
Â  Â Â 
Â  Â  function highlightFilterButton() {
Â  Â  Â  document.querySelectorAll("#filters button").forEach(btn=>btn.classList.remove("active"));
Â  Â  Â  const map = {
Â  Â  Â  Â  "hÃ´m nay":"btn-homnay","tuáº§n":"btn-tuan","thÃ¡ng":"btn-thang",
Â  Â  Â  Â  "nÄƒm":"btn-nam","táº¥t cáº£":"btn-tatca"
Â  Â  Â  };
Â  Â  Â  if (map[currentFilter]) document.getElementById(map[currentFilter]).classList.add("active");
Â  Â  }
Â  Â Â 
Â  Â  function highlightLeaveFilterButton() {
Â  Â  Â  document.querySelectorAll("#leaveSection .controls:nth-child(1) button").forEach(btn=>btn.classList.remove("active"));
Â  Â  Â  const map = {
Â  Â  Â  Â  "hÃ´m nay":"leave-btn-homnay","tuáº§n":"leave-btn-tuan","thÃ¡ng":"leave-btn-thang",
Â  Â  Â  Â  "nÄƒm":"leave-btn-nam","táº¥t cáº£":"leave-btn-tatca"
Â  Â  Â  };
Â  Â  Â  if (map[currentLeaveFilter]) document.getElementById(map[currentLeaveFilter]).classList.add("active");
Â  Â  }
Â  Â Â 
Â  Â  window.onload = () => {
Â  Â  Â  const email = localStorage.getItem("adminEmail");
Â  Â  Â  if (email) {
Â  Â  Â  Â  const username = localStorage.getItem("adminUser");
Â  Â  Â  Â  document.getElementById("loginEmail").style.display = "none";
Â  Â  Â  Â  document.getElementById("loginPass").style.display = "none";
Â  Â  Â  Â  document.getElementById("loginBtn").style.display = "none";
Â  Â  Â  Â  document.getElementById("logoutBtn").style.display = "inline-block";
Â  Â  Â  Â  document.getElementById("greeting").innerHTML = `Xin chÃ o, ${username}!`;
Â  Â  Â  Â  showDashboard();
Â  Â  Â  Â  applyFilter("hÃ´m nay");
Â  Â  Â  } else {
Â  Â  Â  Â  hideDashboard();
Â  Â  Â  }
Â  Â  };
Â  </script>
</body>
</html>
