<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>H·ªá th·ªëng ch·∫•m c√¥ng GPS</title>
  <style>
    :root{
      --bg:#f4f6f9;
      --card:#ffffff;
      --primary:#0d6efd;
      --muted:#6c757d;
      --success:#28a745;
      --danger:#dc3545;
      --radius:10px;
      --shadow: 0 6px 18px rgba(20,20,30,0.06);
      font-family: Inter, "Helvetica Neue", Arial, sans-serif;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:#222}
    .container{max-width:1100px;margin:28px auto;padding:20px;}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{font-size:20px;margin:0;display:flex;gap:10px;align-items:center}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
    .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    input[type="text"], input[type="email"], input[type="password"], input[type="date"], select{
      padding:8px 10px;border:1px solid #e0e3e7;border-radius:6px;font-size:14px;
    }
    button{padding:8px 12px;border-radius:6px;border:0;background:var(--primary);color:#fff;cursor:pointer;font-size:14px}
    button.ghost{background:transparent;color:var(--primary);border:1px solid rgba(13,110,253,0.12)}
    button.warn{background:var(--danger)}
    .small{padding:6px 8px;font-size:13px}
    .table-container{margin-top:12px;max-height:520px;overflow:auto;border-radius:8px;border:1px solid #e6e9ee;background:#fff}
    table{width:100%;border-collapse:collapse}
    th, td{padding:10px 12px;border-bottom:1px solid #f0f2f5;text-align:left;font-size:14px}
    th{position:sticky;top:0;background:#0d6efd;color:#fff;font-weight:600}
    tr:nth-child(even){background:#fbfcff}
    .right{margin-left:auto;display:flex;gap:8px;align-items:center}
    .status{display:inline-block;padding:6px 8px;border-radius:8px;font-size:12px;color:#fff}
    .status.ok{background:var(--success)}
    .status.warn{background:#ffc107;color:#333}
    .status.bad{background:var(--danger)}
    .login-box{display:flex;gap:8px;align-items:center}
    .hint{color:var(--muted);font-size:13px}
    .msg{padding:10px;border-radius:8px;margin-top:10px}
    .msg.error{background:#ffe9e9;color:var(--danger);border:1px solid #ffd0d0}
    .msg.success{background:#e8f8ee;color:var(--success);border:1px solid #c6eed1}
    @media (max-width:720px){
      header{flex-direction:column;align-items:flex-start;gap:10px}
      .controls{width:100%;gap:6px}
      .right{width:100%;justify-content:space-between}
      th, td{padding:8px}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üìå D·ªØ li·ªáu ch·∫•m c√¥ng GPS</h1>

      <div class="right">
        <div id="userArea" class="card login-box" style="padding:8px 10px;">
          <!-- populated by JS -->
          <form id="loginForm" style="display:flex;gap:8px;align-items:center;">
            <input type="email" id="loginEmail" placeholder="Email admin" required />
            <input type="password" id="loginPass" placeholder="M·∫≠t kh·∫©u" required />
            <button type="submit" class="small">ƒêƒÉng nh·∫≠p</button>
          </form>
          <div id="userInfo" style="display:none;gap:8px;align-items:center;">
            <span id="usernameDisplay" style="font-weight:600"></span>
            <button id="logoutBtn" class="ghost small">ƒêƒÉng xu·∫•t</button>
          </div>
        </div>

        <div class="card" style="padding:8px 10px;">
          <a href="/forgot-password" class="hint" style="text-decoration:none;color:var(--muted)">Qu√™n m·∫≠t kh·∫©u?</a>
        </div>
      </div>
    </header>

    <section class="card" style="margin-bottom:12px">
      <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
        <div class="controls">
          <label class="hint" style="margin-right:6px">B·ªô l·ªçc nhanh:</label>
          <button onclick="applyFilter('h√¥m nay')" class="small">H√¥m nay</button>
          <button onclick="applyFilter('tu·∫ßn')" class="small">Tu·∫ßn n√†y</button>
          <button onclick="applyFilter('th√°ng')" class="small">Th√°ng n√†y</button>
          <button onclick="applyFilter('nƒÉm')" class="small">NƒÉm nay</button>
          <button onclick="applyFilter('t·∫•t c·∫£')" class="small">T·∫•t c·∫£</button>
          <button onclick="applyFilter('ngh·ªâ ph√©p')" class="small">Ngh·ªâ ph√©p</button>
        </div>

        <div style="display:flex;align-items:center;gap:8px">
          <label class="hint">T·ª´</label>
          <input type="date" id="startDate" />
          <label class="hint">ƒê·∫øn</label>
          <input type="date" id="endDate" />
          <button onclick="applyDateRange()" class="small">√Åp d·ª•ng</button>
        </div>

        <div style="display:flex;align-items:center;gap:8px;margin-left:auto">
          <input type="text" id="searchBox" placeholder="T√¨m t√™n ho·∫∑c m√£ NV..." />
          <button onclick="applySearch()" class="small">T√¨m</button>
          <button onclick="exportExcel()" class="small">üì• Xu·∫•t Excel</button>
        </div>
      </div>

      <div id="messageArea" style="margin-top:10px"></div>
    </section>

    <section class="card">
      <div class="table-container">
        <table aria-label="D·ªØ li·ªáu ch·∫•m c√¥ng">
          <thead>
            <tr>
              <th>M√£ NV</th>
              <th>T√™n nh√¢n vi√™n</th>
              <th>ƒê·ªãa ch·ªâ</th>
              <th>Ng√†y</th>
              <th>Gi·ªù Check-in</th>
              <th>Tr·∫°ng th√°i</th>
              <th>Ghi ch√∫</th>
            </tr>
          </thead>
          <tbody id="dataBody">
            <!-- rows inserted by JS -->
          </tbody>
        </table>
      </div>
    </section>

    <footer style="margin-top:12px;text-align:center;color:var(--muted);font-size:13px">
      <small>Phi√™n b·∫£n frontend t∆∞∆°ng th√≠ch backend c·ªßa b·∫°n ‚Äî l∆∞u email admin ƒë·ªÉ truy v·∫•n d·ªØ li·ªáu.</small>
    </footer>
  </div>

  <script>
    // tr·∫°ng th√°i/bi·∫øn to√†n c·ª•c
    let CURRENT_FILTER = "h√¥m nay"; // default backend expects "h√¥m nay"
    let START_DATE = "";
    let END_DATE = "";
    let SEARCH = "";
    let RAW_DATA = [];
    const DATA_URL = "/api/attendances";
    const EXPORT_URL = "/api/export-excel";

    // --- helper hi·ªÉn th·ªã message ---
    function showMessage(text, type="error", timeout=5000){
      const area = document.getElementById("messageArea");
      area.innerHTML = `<div class="msg ${type==='error'?'error':'success'}">${text}</div>`;
      if(timeout>0) setTimeout(()=>{ if(area.firstChild) area.innerHTML=""; }, timeout);
    }

    // --- login / logout x·ª≠ l√Ω ---
    const loginForm = document.getElementById("loginForm");
    const loginEmail = document.getElementById("loginEmail");
    const loginPass = document.getElementById("loginPass");
    const userInfo = document.getElementById("userInfo");
    const usernameDisplay = document.getElementById("usernameDisplay");
    const logoutBtn = document.getElementById("logoutBtn");
    const userArea = document.getElementById("userArea");

    function setLogged(email, username){
      localStorage.setItem("attendance_email", email);
      localStorage.setItem("attendance_username", username || "");
      loginForm.style.display = "none";
      userInfo.style.display = "flex";
      usernameDisplay.textContent = username ? `${username} (${email})` : email;
      showMessage("ƒê√£ ƒëƒÉng nh·∫≠p: " + email, "success", 2500);
      loadData(); // t·ª± ƒë·ªông t·∫£i d·ªØ li·ªáu
    }

    function clearLogin(){
      localStorage.removeItem("attendance_email");
      localStorage.removeItem("attendance_username");
      loginForm.style.display = "flex";
      userInfo.style.display = "none";
      usernameDisplay.textContent = "";
      showMessage("ƒê√£ ƒëƒÉng xu·∫•t", "success", 1500);
    }

    // kh·ªüi t·∫°o tr·∫°ng th√°i ƒëƒÉng nh·∫≠p n·∫øu c√≥
    (function initLogin(){
      const saved = localStorage.getItem("attendance_email");
      const savedName = localStorage.getItem("attendance_username");
      if(saved){
        loginForm.style.display = "none";
        userInfo.style.display = "flex";
        usernameDisplay.textContent = savedName ? `${savedName} (${saved})` : saved;
      } else {
        loginForm.style.display = "flex";
        userInfo.style.display = "none";
      }
    })();

    loginForm.addEventListener("submit", async (ev)=>{
      ev.preventDefault();
      const email = loginEmail.value.trim();
      const password = loginPass.value;
      if(!email || !password) return showMessage("Nh·∫≠p email v√† m·∫≠t kh·∫©u", "error");
      try{
        const form = new FormData();
        form.append("email", email);
        form.append("password", password);
        const res = await fetch("/login", { method: "POST", body: form });
        const j = await res.json();
        if(res.ok && j.success){
          setLogged(email, j.username || j.email || "");
          loginEmail.value = "";
          loginPass.value = "";
        } else {
          showMessage(j.message || j.error || "ƒêƒÉng nh·∫≠p th·∫•t b·∫°i", "error");
        }
      }catch(err){
        showMessage("L·ªói m·∫°ng khi ƒëƒÉng nh·∫≠p", "error");
        console.error(err);
      }
    });

    logoutBtn.addEventListener("click", (ev)=>{
      clearLogin();
    });

    // --- fetch d·ªØ li·ªáu ---
    async function loadData(){
      const email = localStorage.getItem("attendance_email");
      if(!email){
        showMessage("Vui l√≤ng ƒëƒÉng nh·∫≠p b·∫±ng email admin ƒë·ªÉ xem d·ªØ li·ªáu", "error", 4000);
        return;
      }

      let url = `${DATA_URL}?email=${encodeURIComponent(email)}&filter=${encodeURIComponent(CURRENT_FILTER)}`;
      if(CURRENT_FILTER === "custom" && START_DATE && END_DATE){
        url += `&startDate=${encodeURIComponent(START_DATE)}&endDate=${encodeURIComponent(END_DATE)}`;
      }
      if(SEARCH) url += `&search=${encodeURIComponent(SEARCH)}`;

      try{
        const res = await fetch(url);
        const j = await res.json();
        if(!res.ok){
          showMessage(j.error || "L·ªói khi l·∫•y d·ªØ li·ªáu", "error");
          RAW_DATA = [];
          renderTable();
          return;
        }
        RAW_DATA = Array.isArray(j) ? j : (j.data || []);
        renderTable();
        showMessage(`T·∫£i ${RAW_DATA.length} b·∫£n ghi`, "success", 1500);
      }catch(err){
        console.error(err);
        showMessage("L·ªói k·∫øt n·ªëi server", "error");
      }
    }

    // --- render table ---
    function renderTable(){
      const tbody = document.getElementById("dataBody");
      tbody.innerHTML = "";
      if(!RAW_DATA || RAW_DATA.length===0){
        tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:24px">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>`;
        return;
      }

      for(const r of RAW_DATA){
        const id = r.EmployeeId || "";
        const name = r.EmployeeName || "";
        const addr = r.Address || "";
        const date = r.CheckinDate || (r.CheckinTime ? formatDateFromAny(r.CheckinTime) : "");
        const time = r.CheckinTime ? formatTimeFromAny(r.CheckinTime) : "";
        const statusText = r.Status || "";
        let statusClass = "ok";
        if(/ngh·ªâ|nghi/i.test(statusText) || /ngh·ªâ ph√©p/i.test((r.Tasks||"")+"")) statusClass = "warn";
        if(/t·ª´ ch·ªëi|rejected|deny/i.test(statusText)) statusClass = "bad";
        const other = (r.OtherNote || r.Tasks || "").toString();

        tbody.insertAdjacentHTML("beforeend", `
          <tr>
            <td>${escapeHtml(id)}</td>
            <td>${escapeHtml(name)}</td>
            <td>${escapeHtml(addr)}</td>
            <td>${escapeHtml(date)}</td>
            <td>${escapeHtml(time)}</td>
            <td><span class="status ${statusClass}">${escapeHtml(statusText)}</span></td>
            <td>${escapeHtml(other)}</td>
          </tr>
        `);
      }
    }

    // --- helpers format time/date (robust) ---
    function formatTimeFromAny(v){
      // if ISO string or datetime object -> show HH:MM:SS
      try{
        if(typeof v === "string"){
          // try parse ISO or "DD/MM/YYYY HH:MM:SS"
          const iso = new Date(v);
          if(!isNaN(iso)) return iso.toTimeString().split(" ")[0];
          // try dd/mm/yyyy hh:mm:ss
          const m = v.match(/(\d{1,2}):(\d{2})(?::(\d{2}))?/);
          if(m) return (m[1].padStart(2,"0")+":"+m[2]+(m[3] ? ":"+m[3] : ":00"));
          return v;
        } else if(v instanceof Date){
          return v.toTimeString().split(" ")[0];
        } else {
          return String(v);
        }
      }catch(e){
        return String(v);
      }
    }
    function formatDateFromAny(v){
      try{
        if(typeof v === "string"){
          const iso = new Date(v);
          if(!isNaN(iso)){
            return iso.getFullYear()+"-"+String(iso.getMonth()+1).padStart(2,"0")+"-"+String(iso.getDate()).padStart(2,"0");
          }
          // try dd/mm/yyyy
          const m = v.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/);
          if(m) return `${m[3].length===2?('20'+m[3]):m[3]}-${m[2].padStart(2,"0")}-${m[1].padStart(2,"0")}`;
          return v;
        } else if(v instanceof Date){
          return v.getFullYear()+"-"+String(v.getMonth()+1).padStart(2,"0")+"-"+String(v.getDate()).padStart(2,"0");
        } else {
          return "";
        }
      }catch(e){
        return "";
      }
    }

    // --- apply filter / search / date range ---
    function applyFilter(f){
      CURRENT_FILTER = f;
      // clear custom dates if not custom
      if(f !== "custom"){
        START_DATE = "";
        END_DATE = "";
        document.getElementById("startDate").value = "";
        document.getElementById("endDate").value = "";
      }
      loadData();
    }

    function applyDateRange(){
      const s = document.getElementById("startDate").value;
      const e = document.getElementById("endDate").value;
      if(!s || !e) return showMessage("Ch·ªçn c·∫£ t·ª´ v√† ƒë·∫øn ng√†y", "error");
      START_DATE = s;
      END_DATE = e;
      CURRENT_FILTER = "custom";
      loadData();
    }

    function applySearch(){
      SEARCH = document.getElementById("searchBox").value.trim();
      loadData();
    }

    // --- export excel ---
    function exportExcel(){
      const email = localStorage.getItem("attendance_email");
      if(!email) return showMessage("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xu·∫•t Excel", "error");
      let url = `${EXPORT_URL}?email=${encodeURIComponent(email)}&filter=${encodeURIComponent(CURRENT_FILTER)}`;
      if(CURRENT_FILTER === "custom" && START_DATE && END_DATE){
        url += `&startDate=${encodeURIComponent(START_DATE)}&endDate=${encodeURIComponent(END_DATE)}`;
      }
      if(SEARCH) url += `&search=${encodeURIComponent(SEARCH)}`;
      // m·ªü link ƒë·ªÉ server tr·∫£ file
      window.location.href = url;
    }

    // --- utility escape ---
    function escapeHtml(text){
      if(text === null || text === undefined) return "";
      return String(text)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // auto-refresh m·ªói 60s (n·∫øu ƒë√£ ƒëƒÉng nh·∫≠p)
    setInterval(()=>{
      if(localStorage.getItem("attendance_email")) loadData();
    }, 60000);

    // N·∫øu ƒë√£ login tr∆∞·ªõc ƒë√≥ th√¨ loadData ngay
    if(localStorage.getItem("attendance_email")) loadData();

    // Expose some functions for console debug
    window._debug = { loadData, applyFilter, applyDateRange, applySearch, exportExcel, clearLogin };
  </script>
</body>
</html>
